{% extends "base.html" %}
{% load static %}
{% block title %} - إضافة عقد{% endblock %}

{% block css %}
    <!-- *************
        ************ Vendor Css Files *************
    ************ -->
    <link rel="stylesheet" href="{% static 'site/vendor/bs-select/bs-select.css' %}">
    <style>
        #departments-container .mb-3:last-child{
            margin: 0 !important;
        }
    </style>
{% endblock %}

{% block breadcrumb %}
    <li class="breadcrumb-item"><a href="{% url 'contracts' %}">العقود</a></li>
    <li class="breadcrumb-item active">إضافة عقد</li>
{% endblock %}
{% block content %}
    <!-- Row start -->
    <div class="row gutters justify-content-center">
        <div class="col-xl-4 col-lg-4 col-md-5 col-sm-6 col-12">
            {% include 'messages.html' %}
            <form method="post" class="needs-validation" novalidate>
                {% csrf_token %}
                <div class="card m-0">
                    <div class="card-header">
                        <div class="card-title">عقد جديد</div>
                        <div class="card-sub-title">إنشاء عقد جديد</div>
                    </div>
                    <div class="card-body">
                        <div class="form-group row gutters">
                            <label for="number" class="col-sm-3 col-form-label text-right">رقم العقد</label>
                            <div class="col-sm-9">
                                <div class="input-group">
                                    <input type="text" class="form-control" id="number" name="number" value="{{ number }}" oninput="this.value = this.value.replace(/[^0-9-]/g, '')" placeholder="رقم العقد" required>
                                    <div class="invalid-feedback">رقم العقد مطلوب</div>
                                </div>
                            </div>
                        </div>

                        <div class="form-group row gutters">
                            <label for="name" class="col-sm-3 col-form-label text-right">مسمى العقد</label>
                            <div class="col-sm-9">
                                <div class="input-group">
                                    <input type="text" class="form-control" id="name" name="name" value="{{ name }}" placeholder="مسمى العقد" required>
                                    <div class="invalid-feedback">رقم العقد مطلوب</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group row gutters">
                            <label for="name" class="col-sm-3 col-form-label text-right">الإدارة</label>
                            <div class="col-sm-9" id="departments-container"></div>
                            <input type="hidden" name="department_id" id="department_id">
                        </div>

                        <div class="form-group row gutters">
                            <label for="amount" class="col-sm-3 col-form-label text-right">قيمة العقد</label>
                            <div class="col-sm-9">
                                <div class="input-group">
                                    <input type="number" class="form-control" id="amount" name="amount" value="{{ amount }}" step=".01" placeholder="قيمة العقد" required>
                                    <div class="invalid-feedback">قيمة العقد مطلوب</div>
                                </div>
                            </div>
                        </div>

                        <div class="form-group row gutters">
                            <label for="signing_date" class="col-sm-3 col-form-label text-right">تاريخ توقيع العقد</label>
                            <div class="col-sm-9">
                                <div class="input-group">
                                    <input type="date" class="form-control" id="signing_date" name="signing_date" value="{{ signing_date|date:'Y-m-d' }}" placeholder="تاريخ توقيع العقد" required>
                                    <div class="invalid-feedback">تاريخ توقيع العقد مطلوب</div>
                                </div>
                            </div>
                        </div>

                        <div class="form-group row gutters">
                            <label for="site_handover_date" class="col-sm-3 col-form-label text-right">تاريخ تسليم الموقع</label>
                            <div class="col-sm-9">
                                <div class="input-group">
                                    <input type="date" class="form-control" id="site_handover_date" name="site_handover_date" value="{{ site_handover_date|date:'Y-m-d' }}" placeholder="تاريخ تسليم الموقع">
                                    <div class="invalid-feedback">تاريخ تسليم الموقع مطلوب</div>
                                </div>
                            </div>
                        </div>

                        <div class="form-group row gutters">
                            <label for="actual_start_date" class="col-sm-3 col-form-label text-right">تاريخ البدء الفعلي</label>
                            <div class="col-sm-9">
                                <div class="input-group">
                                    <input type="date" class="form-control" id="actual_start_date" name="actual_start_date" value="{{ actual_start_date|date:'Y-m-d' }}" placeholder="تاريخ البدء الفعلي">
                                    <div class="invalid-feedback">تاريخ البدء الفعلي مطلوب</div>
                                </div>
                            </div>
                        </div>

                        <div class="form-group row gutters">
                            <label for="duration" class="col-sm-3 col-form-label text-right">المدة</label>
                            <div class="col-sm-9">
                                <div class="input-group">
                                    <input type="number" class="form-control" id="duration" name="duration" value="{{ duration }}" placeholder="المدة" aria-describedby="durationHelpBlock" required>
                                    <small id="durationHelpBlock" class="form-text text-muted mr-1">بالأيام</small>
                                    <div class="invalid-feedback">المدة مطلوبة</div>
                                </div>
                            </div>
                        </div>

                        <div class="form-group row gutters">
                            <label for="company_id" class="col-sm-3 col-form-label text-right">المقاول أو الإستشاري</label>
                            <div class="col-sm-9">
                                <div class="input-group">
                                    <select class="form-control form-control-lg selectpicker" id="company_id" name="company_id" required data-live-search="true" title="اختر">
                                        <optgroup label="مقاول">
                                            {% for contractor in contractors %}
                                            <option value="{{ contractor.id }}" {% if company_id == contractor.id %}selected{% endif %}>{{contractor.name }}</option>
                                            {% endfor %}
                                        </optgroup>
                                        <optgroup label="إستشاري">
                                            {% for consultant in consultants %}
                                            <option value="{{ consultant.id }}" {% if company_id == consultant.id %}selected{% endif %}>{{consultant.name }}</option>
                                            {% endfor %}
                                        </optgroup>
                                    </select>
                                    <div class="invalid-feedback">المقاول أو الإستشاري مطلوب</div>
                                </div>
                            </div>
                        </div>
                        
                        <button type="submit" id="submit" name="submit" class="btn btn-primary float-right">إنشاء</button>
                    </div>
                </div>
            </form>
        </div>
    </div>
    <!-- Row end -->
{% endblock %}

{% block js %}
    <script src="{% static 'site/vendor/bs-select/bs-select.min.js' %}"></script>
    <script>
        const container = document.getElementById('departments-container');
        const hiddenInput = document.getElementById('department_id');

        loadDepartments(null);

        function loadDepartments(parentId) {
            let url = "{% url 'departments_by_parent' %}";
            if (parentId !== null) {
                url += `?parent_id=${parentId}`;
            }

            fetch(url)
                .then(res => res.json())
                .then(data => {
                    if (data.length === 0) return;
                    const wrapper = document.createElement('div');
                    wrapper.className = 'input-group mb-3';

                    const select = document.createElement('select');

                    if (parentId === null) {
                        select.required = true;
                    }
                    select.className = 'form-control form-control-lg';
                    select.innerHTML = `<option value="">اختر الإدارة</option>`;

                    data.forEach(dep => {
                        const option = document.createElement('option');
                        option.value = dep.id;
                        option.textContent = dep.name;
                        select.appendChild(option);
                    });

                    select.onchange = function () {
                        while (wrapper.nextSibling) {
                            wrapper.nextSibling.remove();
                        }

                        if (this.value) {
                            hiddenInput.value = this.value;
                            loadDepartments(this.value);
                        }
                    };

                    wrapper.appendChild(select);
                    container.appendChild(wrapper);
                });
        }
    </script>
{% endblock %}